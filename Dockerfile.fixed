# ä¿®æ­£ç‰ˆæœ¬ - æ”¯æŒè¿è¡Œæ—¶åˆå§‹åŒ–å’ŒSQLite

# =============================================================================
# é˜¶æ®µ1: æ„å»ºåº”ç”¨
# =============================================================================
FROM node:22-alpine AS builder

# å®‰è£…æ„å»ºå·¥å…·
RUN apk add --no-cache git

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å’Œæºä»£ç 
COPY package.json ./
COPY pnpm-lock.yaml ./
COPY pnpm-workspace.yaml ./
COPY packages/ ./packages/
COPY example/ ./example/

# å®‰è£…pnpm
RUN npm install -g pnpm

# è®¾ç½®pnpmé•œåƒæº
RUN pnpm config set registry https://registry.npmmirror.com/

# ä¿®å¤changesetsç‰ˆæœ¬é—®é¢˜
RUN if grep -q '"@changesets/cli": "catalog:"' package.json; then \
    sed -i 's/"@changesets\/cli": "catalog:"/"@changesets\/cli": "^2.29.6"/' package.json; \
    fi

# å®‰è£…æ‰€æœ‰ä¾èµ–
RUN pnpm install

# æ„å»ºåŸºç¡€åŒ…
RUN pnpm build:pkgs

# æ„å»ºReactåº”ç”¨ï¼ˆä½¿ç”¨é»˜è®¤ç¯å¢ƒå˜é‡ï¼‰
RUN cd packages/react-app && \
    export PUBLIC_APP_API_BASE=http://localhost:5300/api/client && \
    export PUBLIC_DIFY_PROXY_API_BASE=http://localhost:5300/api/client/dify && \
    pnpm build

# æ„å»ºPlatformåç«¯ï¼ˆåªç”Ÿæˆå®¢æˆ·ç«¯ï¼Œä¸åˆå§‹åŒ–æ•°æ®åº“ï¼‰
RUN cd packages/platform && \
    pnpm prisma generate && \
    pnpm build

# =============================================================================
# é˜¶æ®µ2: ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶
# =============================================================================
FROM node:22-alpine AS runtime

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache nginx curl openssl

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä»builderé˜¶æ®µå¤åˆ¶å®Œæ•´çš„packagesç›®å½•ï¼ˆä¿æŒworkspaceç»“æ„ï¼‰
COPY --from=builder --chown=nextjs:nodejs /app/packages ./packages

# å¤åˆ¶æ ¹ç›®å½•é…ç½®æ–‡ä»¶
COPY --from=builder --chown=nextjs:nodejs /app/package.json ./package.json
COPY --from=builder --chown=nextjs:nodejs /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder --chown=nextjs:nodejs /app/pnpm-workspace.yaml ./pnpm-workspace.yaml

# å¤åˆ¶nginxé…ç½®
COPY --from=builder --chown=nextjs:nodejs /app/packages/react-app/dist ./html/chat
COPY --from=builder /app/example/nginx.conf.example /etc/nginx/nginx.conf

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p logs && \
    chown -R nextjs:nodejs /app

# å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆåªå®‰è£…runtimeéœ€è¦çš„ï¼‰
RUN npm install -g pnpm pm2 && \
    pnpm install --prod

# åˆ›å»ºè‡ªåŠ¨åŒ–åˆå§‹åŒ–è„šæœ¬
RUN echo 'import bcrypt from "bcryptjs"' > packages/platform/scripts/auto-init.js && \
    echo 'import { PrismaClient } from "@prisma/client"' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo 'const prisma = new PrismaClient()' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo 'const DEFAULT_ADMIN = {' >> packages/platform/scripts/auto-init.js && \
    echo '  email: "admin@dify-chat.com",' >> packages/platform/scripts/auto-init.js && \
    echo '  password: "admin123!",' >> packages/platform/scripts/auto-init.js && \
    echo '  name: "Dify Chat Administrator"' >> packages/platform/scripts/auto-init.js && \
    echo '}' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo 'async function initializeDatabase() {' >> packages/platform/scripts/auto-init.js && \
    echo '  console.log("ğŸ” æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€...")' >> packages/platform/scripts/auto-init.js && \
    echo '  try {' >> packages/platform/scripts/auto-init.js && \
    echo '    await prisma.$queryRaw\`SELECT 1\`' >> packages/platform/scripts/auto-init.js && \
    echo '    console.log("âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸")' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo '    const adminCount = await prisma.user.count({' >> packages/platform/scripts/auto-init.js && \
    echo '      where: { email: DEFAULT_ADMIN.email }' >> packages/platform/scripts/auto-init.js && \
    echo '    })' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo '    if (adminCount === 0) {' >> packages/platform/scripts/auto-init.js && \
    echo '      console.log("ğŸ‘¤ åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·...")' >> packages/platform/scripts/auto-init.js && \
    echo '      const hashedPassword = await bcrypt.hash(DEFAULT_ADMIN.password, 12)' >> packages/platform/scripts/auto-init.js && \
    echo '      await prisma.user.create({' >> packages/platform/scripts/auto-init.js && \
    echo '        data: {' >> packages/platform/scripts/auto-init.js && \
    echo '          email: DEFAULT_ADMIN.email,' >> packages/platform/scripts/auto-init.js && \
    echo '          password: hashedPassword,' >> packages/platform/scripts/auto-init.js && \
    echo '          name: DEFAULT_ADMIN.name,' >> packages/platform/scripts/auto-init.js && \
    echo '          role: "ADMIN"' >> packages/platform/scripts/auto-init.js && \
    echo '        }' >> packages/platform/scripts/auto-init.js && \
    echo '      })' >> packages/platform/scripts/auto-init.js && \
    echo '      console.log(\`âœ… é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ:\`)' >> packages/platform/scripts/auto-init.js && \
    echo '      console.log(\`   é‚®ç®±: \${DEFAULT_ADMIN.email}\`)' >> packages/platform/scripts/auto-init.js && \
    echo '      console.log(\`   å¯†ç : \${DEFAULT_ADMIN.password}\`)' >> packages/platform/scripts/auto-init.js && \
    echo '      console.log(\`   âš ï¸  è¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼\`)' >> packages/platform/scripts/auto-init.js && \
    echo '    } else {' >> packages/platform/scripts/auto-init.js && \
    echo '      console.log("ğŸ‘¤ ç®¡ç†å‘˜è´¦æˆ·å·²å­˜åœ¨")' >> packages/platform/scripts/auto-init.js && \
    echo '    }' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo '    console.log("ğŸ‰ æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼")' >> packages/platform/scripts/auto-init.js && \
    echo '  } catch (error) {' >> packages/platform/scripts/auto-init.js && \
    echo '    console.error("âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:", error)' >> packages/platform/scripts/auto-init.js && \
    echo '    throw error' >> packages/platform/scripts/auto-init.js && \
    echo '  }' >> packages/platform/scripts/auto-init.js && \
    echo '}' >> packages/platform/scripts/auto-init.js && \
    echo '' >> packages/platform/scripts/auto-init.js && \
    echo 'initializeDatabase().catch(console.error)' >> packages/platform/scripts/auto-init.js

# åˆ›å»ºPM2é…ç½®æ–‡ä»¶
RUN echo 'export default {' > ecosystem.config.js && \
    echo '  apps: [{' >> ecosystem.config.js && \
    echo '    name: "dify-chat-platform",' >> ecosystem.config.js && \
    echo '    cwd: "./packages/platform",' >> ecosystem.config.js && \
    echo '    script: "pnpm",' >> ecosystem.config.js && \
    echo '    args: "start",' >> ecosystem.config.js && \
    echo '    env: {' >> ecosystem.config.js && \
    echo '      NODE_ENV: "production",' >> ecosystem.config.js && \
    echo '      PORT: 5300' >> ecosystem.config.js && \
    echo '    },' >> ecosystem.config.js && \
    echo '    instances: 1,' >> ecosystem.config.js && \
    echo '    exec_mode: "fork",' >> ecosystem.config.js && \
    echo '    watch: false,' >> ecosystem.config.js && \
    echo '    max_memory_restart: "1G",' >> ecosystem.config.js && \
    echo '    error_file: "./logs/platform-error.log",' >> ecosystem.config.js && \
    echo '    out_file: "./logs/platform-out.log",' >> ecosystem.config.js && \
    echo '    log_file: "./logs/platform-combined.log",' >> ecosystem.config.js && \
    echo '    time: true,' >> ecosystem.config.js && \
    echo '    autorestart: true,' >> ecosystem.config.js && \
    echo '    max_restarts: 10,' >> ecosystem.config.js && \
    echo '    min_uptime: "10s"' >> ecosystem.config.js && \
    echo '  }]' >> ecosystem.config.js && \
    echo '};' >> ecosystem.config.js

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# è®¾ç½®ç¯å¢ƒå˜é‡' >> /app/start.sh && \
    echo 'if [ ! -z "$DATABASE_URL" ]; then' >> /app/start.sh && \
    echo '  echo "DATABASE_URL=$DATABASE_URL" > /app/packages/platform/.env' >> /app/start.sh && \
    echo 'else' >> /app/start.sh && \
    echo '  echo "DATABASE_URL=file:./prod.db" > /app/packages/platform/.env' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo 'if [ ! -z "$NEXTAUTH_SECRET" ]; then' >> /app/start.sh && \
    echo '  echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> /app/packages/platform/.env' >> /app/start.sh && \
    echo 'else' >> /app/start.sh && \
    echo '  echo "NEXTAUTH_SECRET=$(openssl rand -base64 32)" >> /app/packages/platform/.env' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# è¿è¡Œæ—¶ç¯å¢ƒå˜é‡æ³¨å…¥' >> /app/start.sh && \
    echo 'if [ ! -z "$PUBLIC_APP_API_BASE" ]; then' >> /app/start.sh && \
    echo '  find /app/html/chat -name "*.js" -exec sed -i "s|http://localhost:5300/api/client|$PUBLIC_APP_API_BASE|g" {} \\;' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo 'if [ ! -z "$PUBLIC_DIFY_PROXY_API_BASE" ]; then' >> /app/start.sh && \
    echo '  find /app/html/chat -name "*.js" -exec sed -i "s|http://localhost:5300/api/client/dify|$PUBLIC_DIFY_PROXY_API_BASE|g" {} \\;' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# å¹‚ç­‰æ€§åˆå§‹åŒ–ï¼ˆä¾èµ–Prismaå’Œè„šæœ¬è‡ªèº«çš„å¹‚ç­‰æ€§ï¼‰' >> /app/start.sh && \
    echo 'echo "ğŸ”§ åŒæ­¥æ•°æ®åº“ç»“æ„..."' >> /app/start.sh && \
    echo 'cd /app/packages/platform && pnpm prisma db push' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# æ£€æŸ¥å¹¶åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·ï¼ˆå¹‚ç­‰æ“ä½œï¼‰' >> /app/start.sh && \
    echo 'echo "ğŸ‘¤ æ£€æŸ¥å¹¶åˆå§‹åŒ–ç®¡ç†å‘˜è´¦æˆ·..."' >> /app/start.sh && \
    echo 'node scripts/auto-init.js' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# æ˜¾ç¤ºå¯åŠ¨ä¿¡æ¯' >> /app/start.sh && \
    echo 'echo "ğŸš€ Dify Chat Docker å®¹å™¨å¯åŠ¨æˆåŠŸï¼"' >> /app/start.sh && \
    echo 'echo "ğŸ“± React App: http://localhost/chat"' >> /app/start.sh && \
    echo 'echo "ğŸ”§ Platform API: http://localhost:5300"' >> /app/start.sh && \
    echo 'echo "ğŸ‘¤ é»˜è®¤ç®¡ç†å‘˜: admin@dify-chat.com / admin123"' >> /app/start.sh && \
    echo 'echo "âš ï¸  è¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼"' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# å¯åŠ¨æœåŠ¡' >> /app/start.sh && \
    echo 'nginx -g "daemon off;" &' >> /app/start.sh && \
    echo 'su nextjs -c "cd /app && pm2-runtime ecosystem.config.js"' >> /app/start.sh

RUN chmod +x /app/start.sh

# æš´éœ²ç«¯å£
EXPOSE 5300 80

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:5300/ || curl -f http://localhost/chat/index.html || exit 1

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nextjs

# å¯åŠ¨åº”ç”¨
CMD ["/app/start.sh"]